name: Build Release

on:
    push:
        branches:
            - main
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build:
        runs-on: windows-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  submodules: recursive

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 10.0.x

            - name: Generate Auth File
              shell: pwsh
              env:
                  SECRET_KEY: ${{ secrets.API_AUTH_KEY }}
              run: |
                  $filePath = "${{ github.workspace }}\MemoUploader\Api\ApiSecrets.cs"
                  $content = @"
                  namespace MemoUploader.Api;
                  public class ApiSecrets
                  {
                      public const string AuthKey = "$env:SECRET_KEY";
                  }
                  "@
                  Set-Content -Path $filePath -Value $content

            - name: Install Dalamud
              shell: pwsh
              run: |
                  $targetDir = "${{ github.workspace }}\dalamud_lib"
                  New-Item -ItemType Directory -Force -Path $targetDir

                  $url = "https://github.com/AtmoOmen/Dalamud/releases/latest/download/latest.7z"
                  $archive = "dalamud.7z"

                  Invoke-WebRequest -Uri $url -OutFile $archive
                  7z x $archive "-o$targetDir" -y

            - name: Restore
              run: dotnet restore
              env:
                  DALAMUD_HOME: ${{ github.workspace }}\dalamud_lib

            - name: Build (Release)
              run: dotnet build -c Release --no-restore
              env:
                  DALAMUD_HOME: ${{ github.workspace }}\dalamud_lib

            - name: Read Version
              id: version
              shell: pwsh
              run: |
                  [xml]$csproj = Get-Content MemoUploader/MemoUploader.csproj
                  $version = $csproj.Project.PropertyGroup.Version
                  echo "version=$version" >> $env:GITHUB_OUTPUT

            - name: Create Git Tag
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag v${{ steps.version.outputs.version }}
                  git push origin v${{ steps.version.outputs.version }}

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ steps.version.outputs.version }}
                  files: MemoUploader/bin/Release/MemoUploader/latest.zip
